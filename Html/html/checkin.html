<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Check In | BluePulse</title>
  <link rel="stylesheet" href="employee.css" />
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <h2 class="sidebar-title">Human Resource Planner</h2>
      <nav class="nav-menu">
        <button class="nav-btn" onclick="window.location.href='employee.html'">ğŸ‘¤ Employees</button>
        <button class="nav-btn active" onclick="window.location.href='checkin.html'">ğŸ‘¤ Check In</button>
        <button class="nav-btn" onclick="window.location.href='checkout.html'">ğŸ‘¤ Check Out</button>
        <button class="nav-btn" onclick="window.location.href='attendance.html'">ğŸ•’ Attendance</button>
        <button class="nav-btn">âš™ï¸ Settings</button>
<button class="nav-btn" onclick="goBack()">ğŸ”™ Back</button>
        <button class="nav-btn logout-btn" id="logout">ğŸšª Logout</button>
      </nav>
    </aside>

    <main class="main-content">
      <h1>Check In</h1>
      <div class="form-row">
        <select id="employeeSelect">
          <option value="">Select Employee</option>
        </select>
        <button id="checkInBtn" class="save-btn">Check In</button>
      </div>
    </main>
  </div>
<script>
  function goBack() {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = "dashboard.html";
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  const employeeSelect = document.getElementById("employeeSelect");
  const checkInBtn = document.getElementById("checkInBtn");
  const logout = document.getElementById("logout");

  const EMPLOYEE_API = "http://localhost:5228/api/Employee"; 
  const ATTENDANCE_API = "http://localhost:5228/api/Attendance"; 

  let employees = [];

  // Fetch employees from API
  try {
    const res = await fetch(EMPLOYEE_API);
    employees = await res.json();
    employees.forEach(emp => {
      const option = document.createElement("option");
      option.value = emp.employee_id; 
      option.textContent = emp.first_name + " " + emp.last_name;
      employeeSelect.appendChild(option);
    });
  } catch (err) {
    console.error("Error fetching employees:", err);
    alert("âŒ Failed to load employees!");
  }



checkInBtn.addEventListener("click", async () => {
  const selectedEmpId = employeeSelect.value;
  if (!selectedEmpId) return alert("Select an employee!");

  const selectedEmp = employees.find(emp => emp.employee_id == selectedEmpId);
  if (!selectedEmp) return alert("Invalid employee selected!");

  const now = new Date();
  const todayStr = now.getFullYear() + "-" + 
                   String(now.getMonth() + 1).padStart(2,'0') + "-" + 
                   String(now.getDate()).padStart(2,'0'); // YYYY-MM-DD

  try {
    // Fetch all attendance records
    const resAll = await fetch(ATTENDANCE_API);
    const allAttendance = await resAll.json();

    // Check if employee already checked in today
    const alreadyCheckedIn = allAttendance.some(att => {
      const attDate = new Date(att.attendance_date);
      const attDateStr = attDate.getFullYear() + "-" + 
                         String(attDate.getMonth() + 1).padStart(2,'0') + "-" + 
                         String(attDate.getDate()).padStart(2,'0');
      return att.employee_name === (selectedEmp.first_name + " " + selectedEmp.last_name) &&
             attDateStr === todayStr;
    });

    if (alreadyCheckedIn) {
      return alert(`âš ï¸ ${selectedEmp.first_name} ${selectedEmp.last_name} has already checked in today!`);
    }

    // Proceed to check in
    const payload = {
      attendance_date: todayStr, // YYYY-MM-DD
      employee_name: selectedEmp.first_name + " " + selectedEmp.last_name,
      check_in_time: now.toISOString() // ISO for backend
    };

    const res = await fetch(ATTENDANCE_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const errData = await res.json();
      console.error(errData);
      return alert("âŒ Failed to check in!");
    }

    const data = await res.json();
    alert(`âœ… ${payload.employee_name} checked in successfully`);

  } catch (err) {
    console.error("Error during check-in:", err);
    alert("âŒ Failed to check in!");
  }
});


  logout.addEventListener("click", () => {
    alert("ğŸ‘‹ You have been logged out.");
    window.location.href = "Index.html";
  });
});
</script>

</body>
</html>
