<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Check Out | BluePulse</title>
  <link rel="stylesheet" href="employee.css" />
</head>
<body>
<div class="dashboard-container">
  <aside class="sidebar">
    <h2 class="sidebar-title">Human Resource Planner</h2>
    <nav class="nav-menu">
      <button class="nav-btn" onclick="window.location.href='employee.html'">ğŸ‘¤ Employees</button>
      <button class="nav-btn" onclick="window.location.href='checkin.html'">ğŸ‘¤ Check In</button>
      <button class="nav-btn active" onclick="window.location.href='checkout.html'">ğŸ‘¤ Check Out</button>
      <button class="nav-btn" onclick="window.location.href='attendance.html'">ğŸ•’ Attendance</button>
      <button class="nav-btn">âš™ï¸ Settings</button>
      <button class="nav-btn logout-btn" onclick="window.location.href='Dashboard.html'">ğŸ”™ Back</button>
      <button class="nav-btn logout-btn" id="logout">ğŸšª Logout</button>
    </nav>
  </aside>

  <main class="main-content">
    <h1>Check Out</h1>
    <div class="form-row">
      <select id="employeeSelect">
        <option value="">Select Employee</option>
      </select>
      <button id="checkOutBtn" class="save-btn">Check Out</button>
    </div>
  </main>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const employeeSelect = document.getElementById("employeeSelect");
  const checkOutBtn = document.getElementById("checkOutBtn");
  const logout = document.getElementById("logout");

  const EMPLOYEE_API = "http://localhost:5228/api/Employee";
  const ATTENDANCE_API = "http://localhost:5228/api/Attendance";

  let employees = [];

  // Load employees
  const empRes = await fetch(EMPLOYEE_API);
  employees = await empRes.json();

  employees.forEach(emp => {
    const opt = document.createElement("option");
    opt.value = emp.employee_id;
    opt.textContent = `${emp.first_name} ${emp.last_name}`;
    employeeSelect.appendChild(opt);
  });

  // Checkout
  checkOutBtn.addEventListener("click", async () => {
    const empId = employeeSelect.value;
    if (!empId) return alert("âš ï¸ Select employee");

    const emp = employees.find(e => e.employee_id == empId);
    const today = new Date().toISOString().split("T")[0];
    const now = new Date().toISOString();

    // Get attendance list
    const attRes = await fetch(ATTENDANCE_API);
    const attendance = await attRes.json();

    // Find today's attendance
    const record = attendance.find(a =>
      a.employee_name === `${emp.first_name} ${emp.last_name}` &&
      a.attendance_date.split("T")[0] === today
    );

    if (!record)
      return alert("âš ï¸ Employee has not checked in today");

    if (record.check_out_time)
      return alert("âš ï¸ Employee already checked out");

    // âœ… CORRECT API CALL
    const res = await fetch(
      `${ATTENDANCE_API}/${record.attendance_id}/checkout`,
      {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(now)
      }
    );

    if (!res.ok) {
      const err = await res.text();
      console.error(err);
      return alert("âŒ Checkout failed");
    }

    alert(`âœ… ${emp.first_name} ${emp.last_name} checked out successfully`);
  });

  logout.addEventListener("click", () => {
    window.location.href = "Index.html";
  });
});
</script>

</body>
</html>
